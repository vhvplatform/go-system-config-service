@startuml Secret Management
!theme plain
skinparam backgroundColor #FFFFFF
skinparam defaultFontSize 12

title Secure Secret Storage & Retrieval

actor "Admin User" as Admin
participant "API Gateway" as API
participant "Auth Middleware" as Auth
participant "Secret Service" as SecretService
participant "Encryption Service" as Encryption
participant "Key Management" as KMS
participant "MongoDB" as DB
participant "Redis Cache" as Cache
participant "Audit Log" as Audit
participant "Vault/KMS\n(External)" as Vault

== Store Secret ==

Admin -> API: POST /secrets\n{key, value, env, tenant}
activate API
API -> Auth: Verify permissions
activate Auth
Auth -> Auth: Check role\n(ADMIN or SECRET_MANAGER)
Auth --> API: ✓ Authorized
deactivate Auth

API -> SecretService: Store secret
activate SecretService

SecretService -> KMS: Get encryption key
activate KMS
KMS -> Vault: Request DEK\n(Data Encryption Key)
activate Vault
Vault -> Vault: Generate/Retrieve DEK
Vault --> KMS: Return DEK
deactivate Vault
KMS --> SecretService: Encryption key
deactivate KMS

SecretService -> Encryption: Encrypt secret value
activate Encryption
Encryption -> Encryption: AES-256-GCM encryption
Encryption -> Encryption: Generate IV
Encryption -> Encryption: Calculate HMAC
Encryption --> SecretService: Encrypted data + metadata
deactivate Encryption

SecretService -> DB: Store encrypted secret
activate DB
DB -> DB: Insert document:\n- encrypted_value\n- key_id (which key used)\n- algorithm\n- iv (initialization vector)\n- hmac\n- tenant_id\n- environment\n- metadata
DB -> DB: Create index on:\n  (tenant_id, env, key)
DB --> SecretService: Secret stored
deactivate DB

SecretService -> Audit: Log secret creation
activate Audit
Audit -> DB: Store audit entry\n(masked value)
deactivate Audit

SecretService --> API: Secret stored successfully
deactivate SecretService
API --> Admin: 201 Created
deactivate API

== Retrieve Secret ==

participant "Application" as App

App -> API: GET /secrets/{key}\n?env=prod&tenant=xyz
activate API
API -> Auth: Verify permissions
activate Auth
Auth -> Auth: Check read access
Auth --> API: ✓ Authorized
deactivate Auth

API -> SecretService: Get secret
activate SecretService

SecretService -> Cache: Check cache
activate Cache
Cache --> SecretService: Cache miss
deactivate Cache

SecretService -> DB: Query secret
activate DB
DB -> DB: Find by:\n- key\n- tenant_id\n- environment
DB --> SecretService: Encrypted secret + metadata
deactivate DB

SecretService -> KMS: Get decryption key
activate KMS
KMS -> Vault: Request DEK by key_id
activate Vault
Vault --> KMS: Return DEK
deactivate Vault
KMS --> SecretService: Decryption key
deactivate KMS

SecretService -> Encryption: Decrypt secret
activate Encryption
Encryption -> Encryption: Verify HMAC
Encryption -> Encryption: AES-256-GCM decryption
Encryption --> SecretService: Plain text value
deactivate Encryption

SecretService -> Cache: Cache decrypted value\n(with short TTL)
activate Cache
Cache -> Cache: Set with 5min TTL
Cache --> SecretService: Cached
deactivate Cache

SecretService -> Audit: Log secret access
activate Audit
Audit -> DB: Store access log
deactivate Audit

SecretService --> API: Secret value
deactivate SecretService
API --> App: 200 OK\n{value: "***"}
deactivate API

== Rotate Secret ==

Admin -> API: POST /secrets/{key}/rotate
activate API
API -> Auth: Verify admin permissions
activate Auth
Auth --> API: ✓ Authorized
deactivate Auth

API -> SecretService: Rotate secret
activate SecretService

SecretService -> SecretService: Generate new value
SecretService -> KMS: Get new encryption key
activate KMS
KMS -> Vault: Request new DEK
activate Vault
Vault -> Vault: Generate new DEK
Vault --> KMS: New DEK + key_id
deactivate Vault
KMS --> SecretService: New encryption key
deactivate KMS

SecretService -> Encryption: Encrypt with new key
activate Encryption
Encryption --> SecretService: New encrypted data
deactivate Encryption

SecretService -> DB: Begin transaction
activate DB
DB -> DB: Copy old version to history
DB -> DB: Update with new encrypted value
DB -> DB: Increment version
DB -> DB: Mark old key for deletion
DB -> DB: Commit transaction
DB --> SecretService: Secret rotated
deactivate DB

SecretService -> Cache: Invalidate old cache
activate Cache
Cache -> Cache: Delete all related entries
Cache --> SecretService: Cache cleared
deactivate Cache

SecretService -> Audit: Log rotation
activate Audit
Audit -> DB: Store rotation audit
deactivate Audit

SecretService --> API: Rotation successful
deactivate SecretService
API --> Admin: 200 OK
deactivate API

== Access Control Matrix ==

note over Auth
  **Permission Levels**
  
  | Role              | Read | Write | Rotate | Delete |
  |-------------------|------|-------|--------|--------|
  | SUPER_ADMIN       | ✓    | ✓     | ✓      | ✓      |
  | SECRET_MANAGER    | ✓    | ✓     | ✓      | ✗      |
  | SERVICE_ACCOUNT   | ✓    | ✗     | ✗      | ✗      |
  | DEVELOPER         | ✓*   | ✗     | ✗      | ✗      |
  
  * Dev only for dev/staging envs
end note

note over Encryption
  **Encryption Details**
  
  - Algorithm: AES-256-GCM
  - Key derivation: PBKDF2
  - Unique IV per secret
  - HMAC for integrity
  - Envelope encryption
  - Key rotation support
end note

note over DB
  **Secret Storage Schema**
  {
    _id: ObjectId,
    key: "db_password",
    encrypted_value: "...",
    key_id: "key-v2",
    algorithm: "AES-256-GCM",
    iv: "...",
    hmac: "...",
    tenant_id: "xyz",
    environment: "production",
    version: 3,
    created_at: timestamp,
    updated_at: timestamp,
    expires_at: timestamp,
    metadata: {
      description: "...",
      tags: [...]
    }
  }
end note

note over Vault
  **Key Management**
  
  - Master key stored in Vault/KMS
  - DEKs (Data Encryption Keys)
    generated per secret or tenant
  - Regular key rotation
  - Key versioning
  - Secure key deletion
  - Compliance (PCI-DSS, GDPR)
end note

@enduml
